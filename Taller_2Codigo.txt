# Cargar la base de datos en R
datos <- read.table("C:/Users/User/Desktop/datos_iniciales.csv", header = TRUE, sep = ",")  

# Instalar paquetes necesarios 
if (!require("vegan")) install.packages("vegan", dependencies = TRUE)
if (!require("ggplot2")) install.packages("ggplot2", dependencies = TRUE)

# Cargar librer칤as
library(vegan)
library(ggplot2)

# Verificamos la estructura de los datos
head(datos)

# Contar la abundancia de cada especie (si sp es la columna correcta)
abundancias <- table(datos$sp)  

# Verificar si la tabla de abundancias no est치 vac칤a
if (length(abundancias) == 0) {
  stop("Error: La tabla de abundancias est치 vac칤a. Verifica la columna de especies en los datos.")
}

# Definir los tama침os de muestra para rarefacci칩n (evitar valores mayores a la poblaci칩n total)
tamanos_muestra <- seq(10, min(10000, sum(abundancias)), by = 50)  

# Calcular la curva de rarefacci칩n
curva_rarefaccion <- rarefy(abundancias, tamanos_muestra)

# Verificar que se gener칩 correctamente
if (is.null(curva_rarefaccion)) {
  stop("Error: No se pudo calcular la curva de rarefacci칩n.")
}

# Calcular la variabilidad (errores est치ndar)
error_std <- tryCatch({
  rareslope(abundancias, tamanos_muestra)
}, error = function(e) {
  warning("No se pudo calcular el error est치ndar de rarefacci칩n. Se usar치 NA.")
  rep(NA, length(tamanos_muestra))
})

# Crear un dataframe con los resultados
df_rarefaccion <- data.frame(
  Muestra = tamanos_muestra,
  Riqueza = as.numeric(curva_rarefaccion),  # Asegurar formato num칠rico
  ErrorStd = as.numeric(error_std)
)

# Verificar que el dataframe se cre칩 correctamente
head(df_rarefaccion)

# 游늵 Graficar la curva de rarefacci칩n con ggplot2
ggplot(df_rarefaccion, aes(x = Muestra, y = Riqueza)) +
  geom_line(color = "blue", size = 1) +  # L칤nea principal
  geom_ribbon(aes(ymin = Riqueza - ErrorStd, ymax = Riqueza + ErrorStd), 
              fill = "lightblue", alpha = 0.5) +  # Sombra para la variabilidad
  labs(title = "Curva de Rarefacci칩n",
       x = "N칰mero de Individuos Muestreados",
       y = "N칰mero Esperado de Especies") +
  theme_minimal()

# Guardar la gr치fica
ggsave("curva_rarefaccion.png", width = 7, height = 5, dpi = 300)








# Haciendo bootstraping:

# Cargar la base de datos en R
datos <- read.table("C:/Users/User/Desktop/datos_iniciales.csv", header=TRUE)  

# Cargar paquetes necesarios
library(vegan)
library(ggplot2)

# Contar la abundancia de cada especie
abundancias <- table(datos$sp)  

# Definir los tama침os de muestra (de 10 a 10,000 en pasos de 50)
tamanos_muestra <- seq(10, 10000, by = 50)  

# N칰mero de repeticiones para el bootstrapping
num_repeticiones <- 100  

# Funci칩n para hacer bootstrapping
bootstrapping_rarefaccion <- function(n) {
  especies_estimadas <- numeric(num_repeticiones)
  
  for (i in 1:num_repeticiones) {
    muestra <- sample(names(abundancias), size = n, replace = TRUE, prob = abundancias)
    especies_estimadas[i] <- length(unique(muestra))  # Contar especies 칰nicas en la muestra
  }
  
  return(c(media = mean(especies_estimadas), sd = sd(especies_estimadas)))  # Media y desviaci칩n est치ndar
}

# Aplicar bootstrapping a cada tama침o de muestra
resultados_boot <- t(sapply(tamanos_muestra, bootstrapping_rarefaccion))
colnames(resultados_boot) <- c("media", "sd")

# Convertir resultados a data frame para ggplot2
df_boot <- data.frame(TamanoMuestra = tamanos_muestra, 
                      RiquezaMedia = resultados_boot[, "media"], 
                      DesviacionStd = resultados_boot[, "sd"])

# Graficar la curva de rarefacci칩n con barras de error
ggplot(df_boot, aes(x = TamanoMuestra, y = RiquezaMedia)) +
  geom_line(color = "blue") +
  geom_ribbon(aes(ymin = RiquezaMedia - DesviacionStd, ymax = RiquezaMedia + DesviacionStd), 
              alpha = 0.2, fill = "blue") +
  labs(title = "Curva de Rarefacci칩n con Bootstrapping",
       x = "N칰mero de Individuos Muestreados",
       y = "N칰mero Esperado de Especies") +
  theme_minimal()

